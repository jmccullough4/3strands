{% extends 'layouts/base.html' %}
{% block content %}
  <div class="row g-4 mb-4">
    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-body d-flex flex-column gap-3">
          <div>
            <h1 class="h4 brand-accent mb-2">Shared Task Board</h1>
            <p class="text-secondary mb-0">Coordinate processing runs, farmers market prep, and cooler upkeep so every order stays on track.</p>
          </div>
          <form method="post" action="{{ url_for('create_task') }}" class="d-grid gap-3">
            <div>
              <label for="title" class="form-label">Task title</label>
              <input type="text" class="form-control" id="title" name="title" placeholder="Schedule beef processing pickup" required>
            </div>
            <div>
              <label for="description" class="form-label">Details</label>
              <textarea class="form-control" id="description" name="description" rows="3" placeholder="Include delivery stops, feed schedules, or marketing notes."></textarea>
            </div>
            <div>
              <label for="list_id" class="form-label">Start in list</label>
              <select class="form-select" id="list_id" name="list_id" {% if not active_task_lists %}disabled{% endif %}>
                {% if active_task_lists %}
                  {% for task_list in active_task_lists %}
                    <option value="{{ task_list['id'] }}">{{ task_list['name'] }}</option>
                  {% endfor %}
                {% else %}
                  <option value="">Create a list to start assigning work</option>
                {% endif %}
              </select>
            </div>
            <div>
              <label for="assigned_to" class="form-label">Assign to</label>
              <select class="form-select" id="assigned_to" name="assigned_to">
                <option value="">Unassigned</option>
                {% for member in assignable_users %}
                  <option value="{{ member['id'] }}">{{ member['display_name'] }}</option>
                {% endfor %}
              </select>
              {% if not assignable_users %}
                <div class="form-text text-secondary">Invite team members from the Admin area to assign tasks.</div>
              {% endif %}
            </div>
            <button type="submit" class="btn btn-brand" {% if not active_task_lists %}disabled{% endif %}>Add to Board</button>
          </form>
          {% if not active_task_lists %}
            <div class="small text-warning">Add an active list below to start logging new tasks. Completed items archive automatically.</div>
          {% endif %}
          <div class="small text-secondary">
            Tip: Check tasks off when the work is wrapped â€” they will slide into your Completed list automatically. Use the assignment picker so crew members know what is expected.
          </div>
          <form method="post" action="{{ url_for('create_task_list') }}" class="d-grid gap-2 mt-4">
            <div>
              <label for="list-name" class="form-label">Add a new list</label>
              <input type="text" class="form-control" id="list-name" name="name" placeholder="Add 'Butcher Prep' or 'Farmers Market'" required>
            </div>
            <button type="submit" class="btn btn-outline-straw">Create List</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-xl-6">
      <div class="card h-100 cooler-placeholder">
        <div class="card-body d-flex flex-column gap-3">
          <h2 class="h5 brand-accent mb-1">Board Quick Reference</h2>
          <p class="text-secondary mb-0">Use the lists below to visualize workflow from chute to delivery. Toggle the checkbox on any card to mark it complete and archive it into the finish column.</p>
          <ul class="small text-secondary mb-0 ps-3">
            <li>Assign each task to a hands-on teammate so responsibilities are clear.</li>
            <li>Drop delivery routes, vet contacts, or ministry follow-up notes in the details field.</li>
            <li>Need crew members? Create them from the Admin tools and they will appear here automatically.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  {% if board_lists %}
    <div class="row g-4 task-board-row">
      {% for task_list in board_lists %}
        {% set is_completed = completed_list_id and task_list['id'] == completed_list_id %}
        <div class="col-lg-4">
          <div class="task-column h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0 text-uppercase letter-spacing-1">{{ task_list['name'] }}</h2>
              <div class="d-flex align-items-center gap-2">
                <span class="badge rounded-pill text-bg-warning text-dark">{{ tasks_by_list.get(task_list['id'], [])|length }}</span>
                {% if not is_completed %}
                  <button class="btn btn-sm btn-outline-straw" type="button" data-bs-toggle="collapse" data-bs-target="#list-actions-{{ task_list['id'] }}" aria-expanded="false" aria-controls="list-actions-{{ task_list['id'] }}">Manage</button>
                {% else %}
                  <span class="badge rounded-pill text-bg-secondary">Auto-archive</span>
                {% endif %}
              </div>
            </div>
            {% if not is_completed %}
              <div class="collapse mb-3" id="list-actions-{{ task_list['id'] }}">
                <form method="post" action="{{ url_for('rename_task_list', list_id=task_list['id']) }}" class="d-grid gap-2 mb-2">
                  <label class="form-label small" for="rename-{{ task_list['id'] }}">Rename list</label>
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="rename-{{ task_list['id'] }}" name="name" value="{{ task_list['name'] }}" required>
                    <button class="btn btn-outline-warning" type="submit">Save</button>
                  </div>
                </form>
                <form method="post" action="{{ url_for('delete_task_list', list_id=task_list['id'] ) }}" onsubmit="return confirm('Remove this list? Tasks must be moved first.');">
                  <button class="btn btn-sm btn-outline-danger w-100" type="submit">Delete list</button>
                </form>
              </div>
            {% else %}
              <div class="small text-secondary mb-3">Checked-off tasks land here and stay searchable for audits.</div>
            {% endif %}
            <div class="d-grid gap-3">
              {% set column_tasks = tasks_by_list.get(task_list['id'], []) %}
              {% if column_tasks %}
                {% for task in column_tasks %}
                  <div class="task-card card">
                    <div class="card-body d-flex flex-column gap-3">
                      <div>
                        <h3 class="h6 mb-1 text-light">{{ task['title'] }}</h3>
                        {% if task['description'] %}
                          <p class="small text-secondary mb-0">{{ task['description'] }}</p>
                        {% endif %}
                      </div>
                      <div class="d-flex flex-wrap justify-content-between align-items-center small text-secondary gap-2">
                        <span>Logged by {{ task['creator'] or 'team member' }}</span>
                        <span>{{ task['created_at'] or '' }}</span>
                      </div>
                      <div class="small text-secondary fw-semibold">
                        {% if task['assignee'] %}
                          Assigned to {{ task['assignee'] }}
                        {% else %}
                          Unassigned
                        {% endif %}
                      </div>
                      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <form method="post" action="{{ url_for('toggle_task_completion', task_id=task['id']) }}" class="task-complete-form d-flex align-items-center">
                          <input type="hidden" name="completed" value="{% if completed_list_id and task['list_id'] == completed_list_id %}1{% else %}0{% endif %}">
                          <input type="hidden" name="current_list_id" value="{{ task_list['id'] }}">
                          <div class="form-check m-0">
                            <input class="form-check-input" type="checkbox" id="complete-{{ task['id'] }}"
                                   {% if completed_list_id and task['list_id'] == completed_list_id %}checked{% endif %}
                                   onchange="const form=this.closest('form'); form.querySelector('[name=completed]').value = this.checked ? '1' : '0'; form.submit();">
                            <label class="form-check-label small text-secondary" for="complete-{{ task['id'] }}">
                              {% if completed_list_id and task['list_id'] == completed_list_id %}
                                Completed
                              {% else %}
                                Mark complete
                              {% endif %}
                            </label>
                          </div>
                        </form>
                        <div class="d-flex flex-wrap gap-2">
                          <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#edit-task-{{ task['id'] }}" aria-expanded="false" aria-controls="edit-task-{{ task['id'] }}">Edit</button>
                          <form method="post" action="{{ url_for('delete_task', task_id=task['id']) }}" onsubmit="return confirm('Delete this task?');">
                            <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                          </form>
                        </div>
                      </div>
                      <div class="collapse" id="edit-task-{{ task['id'] }}">
                        <form method="post" action="{{ url_for('update_task', task_id=task['id']) }}" class="task-edit-form d-grid gap-2 mt-3">
                          <div>
                            <label class="form-label small" for="title-{{ task['id'] }}">Title</label>
                            <input type="text" class="form-control form-control-sm" id="title-{{ task['id'] }}" name="title" value="{{ task['title'] }}" required>
                          </div>
                          <div>
                            <label class="form-label small" for="description-{{ task['id'] }}">Details</label>
                            <textarea class="form-control form-control-sm" id="description-{{ task['id'] }}" name="description" rows="3">{{ task['description'] or '' }}</textarea>
                          </div>
                          <div>
                            <label class="form-label small" for="assigned-to-{{ task['id'] }}">Assign to</label>
                            <select class="form-select form-select-sm" id="assigned-to-{{ task['id'] }}" name="assigned_to">
                              <option value="" {% if not task['assigned_to'] %}selected{% endif %}>Unassigned</option>
                              {% for member in assignable_users %}
                                <option value="{{ member['id'] }}" {% if task['assigned_to'] == member['id'] %}selected{% endif %}>{{ member['display_name'] }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="text-end">
                            <button class="btn btn-sm btn-brand" type="submit">Save changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="empty-column text-secondary text-center py-4 px-3">
                  {% if is_completed %}
                    Completed assignments will stack here after you mark them finished.
                  {% else %}
                    No tasks here yet. Create one above and check it off once the crew is finished.
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info bg-dark border-warning text-warning" role="alert">
      Create your first list to start planning the next processing day.
    </div>
  {% endif %}
{% endblock %}
